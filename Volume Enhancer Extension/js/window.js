function debounce(e,t=300){let a;return(...n)=>{clearTimeout(a),a=setTimeout((()=>{e.apply(this,n)}),t)}}class Popup{constructor(){this.gainValueInput=document.querySelector("#volume-slider"),this.volumeCurrent=document.querySelector("#volume-current"),this.tabsTitle=document.querySelector(".tabs__title"),this.tabsList=document.querySelector(".tabs__list"),this.playingTabId=null,this.storage=null,this.handleDocumentKeyPress=this.handleDocumentKeyPress.bind(this),this.run(),chrome.tabs.onUpdated.addListener(debounce((()=>{this.showPlayingTabs()}),500)),chrome.tabs.onRemoved.addListener((e=>{this.getPopupId(e).then((e=>this.getWindow(e))).then((e=>chrome.windows.remove(e))).then((()=>this.showPlayingTabs()))}))}run(){return this.changeHref(),this.getPlayingTabId().then((()=>this.initializeAudioContext())).then((()=>this.renderVolumeControlValue(100))).then((()=>this.showPlayingTabs())).then((()=>this.initListeners())).then((()=>this.initStorage()))}changeHref(){const e=navigator.userAgentData.brands.find((e=>"Google Chrome"===e.brand||"Microsoft Edge"===e.brand));let t=null;e.brand.match(/Edge/i)?t="https://microsoftedge.microsoft.com/addons/detail/"+chrome.runtime.id:e.brand.match(/Chrome/i)&&(t="https://chrome.google.com/webstore/detail/"+chrome.runtime.id+"/reviews"),document.querySelector(".link").setAttribute("href",`${t}`)}getPopupId(e){return new Promise((t=>{const a=`popup_${e}`;chrome.storage.local.get([a],(e=>{t(e[a])}))}))}getWindow(e){return new Promise((t=>{chrome.windows.get(e,(e=>{t(e.id)}))}))}async initializeAudioContext(){const e=(await chrome.tabs.getCurrent())?.id;chrome.tabCapture.getMediaStreamId({consumerTabId:e,targetTabId:this.playingTabId},(e=>{this.getMediaStream(e).then((e=>{const t=new AudioContext,a=t.createMediaStreamSource(e);this.gainNode=t.createGain(),a.connect(this.gainNode),this.gainNode.connect(t.destination)}))}))}getPlayingTabId(){return new Promise((e=>{chrome.tabs.query({active:!0},(t=>{chrome.runtime.lastError||(this.playingTabId=t[0].id,e(this.playingTabId))}))}))}showPlayingTabs(){this.tabsList.innerHTML="",chrome.tabs.query({audible:!0,windowType:"normal"},(e=>{e.sort(((e,t)=>t.id-e.id)),this.tabsTitle.textContent=e.length?"Playing sound currently on tabs":"No tabs playing  audio right now",e.forEach((e=>{const t=document.querySelector("#template-tab").content;t.querySelector(".tab").dataset.tabId=e.id,t.querySelector(".tab__icon-image").src=e.favIconUrl,t.querySelector(".tab__title").textContent=e.title,this.tabsList.appendChild(document.importNode(t,!0))}))}))}initStorage(){return new Promise((e=>{chrome.storage.local.get({usedIds:[],installationDate:null},(t=>{if(t.installationDate)this.storage=t,this.storage.installationDate=JSON.parse(t.installationDate);else{t.installationDate=new Date;const e=JSON.stringify(t.installationDate);this.storage=t,this.saveToStorage({installationDate:e})}e()}))}))}initListeners(){this.initDOMListeners()}initDOMListeners(){$("#insite-controller").on("click",(e=>{this.handleGainChangeButton(e),this.changeSwitcher()})),this.gainValueInput.addEventListener("input",(e=>this.handleGainChange(e.target.value))),this.tabsList.addEventListener("click",(e=>this.handleTabListClick(e))),document.documentElement.addEventListener("keypress",this.handleDocumentKeyPress)}handleDocumentKeyPress(e){e.preventDefault();const t=e.key.toLowerCase(),a=+t;if(!isNaN(a)){const e=100*a,t=+this.gainValueInput.max;return+this.gainValueInput.min<=e&&e<=t?(this.gainValueInput.value=e,this.volumeCurrent.textContent=e,this.gainNode.gain.value=e/100,void chrome.tabs.sendMessage(this.playingTabId,{action:"showGain",installationDate:null})):void 0}"r"===t&&window.location.reload()}renderVolumeControlValue(e){this.gainValueInput.value=e,this.volumeCurrent.textContent=e}async handleGainChange(e){let t=this.playingTabId;const a=parseInt(e,10);this.gainNode.gain.value=a/100,this.renderVolumeControlValue(a),this.updateBadge(t,a),chrome.tabs.sendMessage(t,{action:"showGain",volume:a})}getMediaStream(e){return new Promise((t=>{t(navigator.mediaDevices.getUserMedia({video:!1,audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}}))}))}updateBadge(e,t){chrome.action.setBadgeText({text:`${t}`,tabId:e})}handleGainChangeButton(){let e=this.playingTabId;this.gainNode.gain.value=1,this.volumeCurrent.textContent=100,this.gainValueInput.textContent=100,this.updateBadge(e,100),chrome.tabs.sendMessage(this.playingTabId,{action:"showGain",volume:100})}changeSwitcher(){const e=$("#volume-slider");e.prop("value",100),e.attr("disabled")?e.attr("disabled",!1):(e.attr("disabled",!0),e.css("background-size","20%"))}handleTabListClick(e){e.preventDefault();const t=e.target.closest(".tab"),a=parseInt(t.dataset.tabId,10);chrome.tabs.update(a,{active:!0},(e=>{chrome.windows.update(e.windowId,{focused:!0})}))}saveToStorage(e,t=(()=>{})){chrome.storage.local.set(e,(e=>{t()}))}}const popup=new Popup;